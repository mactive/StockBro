<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AutoComplate</title>

    <!-- libraries -->
    <link href="css/autocomplate.css" rel="stylesheet" type="text/css">
</head>
<body>
<section>
    <div id="example">
        <h3>Example</h3>
        <form action="#">
            <input type="text" placeholder="Stock symbol or short" id="plugin" onkeyup="this.value=this.value.toLocaleUpperCase()"/>
        </form>
    </div>
    <div id="selected">
        <h3>Selected Item</h3>
        <p></p>
        <div class="realtime">
            <span class="symbol"></span>
            <span class="name"></span>
            <span class="open"></span>
            <span class="close"></span>
            <span class="high"></span>
            <span class="low"></span>
        </div>
    </div>
    <div id="chart">
        <img src="" alt="">
    </div>
</section>

</body>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script type="text/javascript" src="http://underscorejs.org/underscore-min.js"></script>
<script type="text/javascript" src="http://backbonejs.org/backbone-min.js"></script>
<script src="/js/backbone.autocomplete.js"></script>
<script src="/js/stock.list.objects.js"></script>
<script type="text/javascript">
    $(function () {

        /* ================================
         * AutoComplate 
         * ================================ 
         */ 

        var Plugin = Backbone.Model.extend({
            label: function () {
                return this.get("symbol") +"  "+ this.get("short") ;
            },
            label_for_show: function(){
                return this.get("symbol") +" "+ this.get("name") ;
            }
        });

        var PluginCollection = Backbone.Collection.extend({
            model: Plugin
        });

        // object {"symbol":"sz000030","short":"FAGF","name":"富奥股份"},
        var plugins = new PluginCollection(STOCK_LIST_OBJECTS);

        new AutoCompleteView({
            input: $("#plugin"),
            model: plugins,
            onSelect: function (model) {
                // AutoComplate list
                $("#selected").show().find("p").html(model.label_for_show());
                // Chart Image
                $("#chart").find("img").attr('src','http://chart.7878.com/kd/'+model.get("symbol")+'.gif');
            }
        }).render();


        /* 
         * =============================================================
         * fetch 
         * ============================================================= 
         */ 

        window.OneStockModel = Backbone.Model.extend({
            initialize:function(){
                console.log("create a model");
            },
            defaults:{
                symbol:'SH000000',
                time:'获取时间',
                name:'股票时间',
                close:'',
                open:'',
                high:'',
                low:'',
                current:'',
                volumn:'',
                amount:'',
                buy1:'',
                buy2:'',
                buy3:'',
                buy4:'',
                buy5:'',
                sell1:'',
                sell2:'',
                sell3:'',
                sell4:'',
                sell5:'',
                volumn_buy1:'',
                volumn_buy2:'',
                volumn_buy3:'',
                volumn_buy4:'',
                volumn_buy5:'',
                volumn_sell1:'',
                volumn_sell2:'',
                volumn_sell3:'',
                volumn_sell4:'',
                volumn_sell5:''
            }
        });

        window.OneShockCollection=Backbone.Collection.extend({
            model:OneStockModel,
            url:'http://api.stockpro.com/stock/realtime/ddd',
            initialize:function(){
                this.bind('reset',this.showAll);
                this.bind('add',this.showAll);
            },
            parse:function(response){
                console.log('parse first');
                var result = {
                    symbol: response.c,
                    time:   response.t,
                    name:   response.n,
                    close:  response.lc,
                    open:   response.o,
                    high:   response.h,
                    low:    response.l,
                    current:    response.np,
                    volumn: response.v,
                    amount: response.a,
                    buy1:   response.bp[0],
                    buy2:   response.bp[1],
                    buy3:   response.bp[2],
                    buy4:   response.bp[3],
                    buy5:   response.bp[4],
                    sell1:  response.sp[0],
                    sell2:  response.sp[1],
                    sell3:  response.sp[2],
                    sell4:  response.sp[3],
                    sell5:  response.sp[4],
                    volumn_buy1:    response.bv[0],
                    volumn_buy2:    response.bv[1],
                    volumn_buy3:    response.bv[2],
                    volumn_buy4:    response.bv[3],
                    volumn_buy5:    response.bv[4],
                    volumn_sell1:   response.sv[0],
                    volumn_sell2:   response.sv[1],
                    volumn_sell3:   response.sv[2],
                    volumn_sell4:   response.sv[3],
                    volumn_sell5:   response.sv[4]
                };

                return result;

            },
            showAll:function(){
                this.each(function(model){

                    alert(model.get('name'));
                })
            },
        })
        
        var test = new OneShockCollection();
        test.fetch({url:'http://api.stockpro.com/stock/realtime/ddd',
            success:function(collection,response){
                collection.each(function(single){
                    console.log("success"+single.get('name'));
                    console.log("success"+single.get('buy1'));
                    console.log("success"+single.get('volumn_buy1'));
                })
            },
            error:function(collection, response){
                console.log(collection);
                console.log(response);
                alert('error');
            }
        })


    });
</script>

</html>